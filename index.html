<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>ì§€ë„ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      gap: 20px;
      padding: 20px;
      font-family: Arial, sans-serif;
      height: 100vh; /* ì „ì²´ í™”ë©´ ë†’ì´ */
      box-sizing: border-box;
    }

    #left-container {
      flex: 1 1 45%;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      max-height: 100vh;
    }

    #right-container {
      flex: 1 1 55%;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      box-sizing: border-box;
      max-height: 100vh;
    }

    h3, h4 {
      margin: 20px 0 10px 0;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }

    thead th {
      border: 1px solid #999;
      padding: 6px 10px;
      text-align: center;
      background: #f0f0f0;
      font-weight: bold;
      word-break: break-word;
    }

    tbody td {
      border: 1px solid #999;
      padding: 6px 10px;
      word-break: break-word;
      text-align: center;
      cursor: pointer;
    }

    tbody tr:hover {
      background-color: #eef;
    }

    .table-body-wrapper {
      max-height: 40vh;
      overflow-y: auto;
      border: 1px solid #999;
      border-radius: 4px;
    }

    /* ê²€ìƒ‰ê²°ê³¼ì—ë§Œ ë†’ì´ ì œí•œ ì ìš© */
    .table-body-wrapper.address-table {
      max-height: 20vh;
      overflow-y: auto;
      border: 1px solid #999;
      border-radius: 4px;
    }

    /* ì„ íƒ ë¦¬ìŠ¤íŠ¸ëŠ” ì œí•œ ì—†ìŒ */
    .table-body-wrapper.selected-table {
      max-height: none;
      overflow-y: visible;
      border: 1px solid #999;
      border-radius: 4px;
    }

    input[type="text"], input[type="file"], button {
      margin: 4px 0;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #999;
    }

    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      transition: background-color 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    #map {
      flex-grow: 1;
      height: 100%; /* ë¶€ëª¨ ë†’ì´ ê½‰ ì±„ìš°ê¸° */
      border: 1px solid #999;
      border-radius: 8px;
      min-height: 0; /* ê¸°ì¡´ min-height í•´ì œ */
    }

    .name-list-label {
      display: inline;
      white-space: nowrap;
      padding: 2px 6px;
      background: rgba(255,255,255,0.8);
      border-radius: 4px;
      border: 1px solid #333;
      font-weight: bold;
      font-size: 20px;
      line-height: 1.3em;
      color: black;
      pointer-events: none;
      user-select: none;
      position: absolute;
      z-index: 10;
    }

    #loading-indicator {
      display: none;
      margin: 10px 0;
      font-weight: bold;
      color: #d33;
    }

    /* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #password-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    #password-modal.flex {
      display: flex;
    }

    #password-modal .modal-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      width: 300px;
      text-align: center;
    }

    #password-modal input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      font-size: 16px;
    }

    #password-modal button {
      padding: 6px 12px;
      margin: 10px 5px 0;
      font-size: 14px;
    }

    #address-convert-area {
      display: none;
      border: 2px solid #007bff;
      background-color: #e6f0ff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }

    #address-convert-area h3 {
      color: #0056b3;
      font-weight: 700;
    }

    button#clear-search-result,
    button#clear-selected {
      background-color: #f8d7da; /* ì—°í•œ ë¶„í™ìƒ‰ ë°°ê²½ */
      color: #842029; /* ì§„í•œ ë¶‰ì€ìƒ‰ ê¸€ì”¨ */
      border: 1px solid #f5c2c7; /* ì—°í•œ ë¶‰ì€ í…Œë‘ë¦¬ */
    }

    button#clear-search-result:hover,
    button#clear-selected:hover {
      background-color: #f5c2c7; /* ì•½ê°„ ë” ì§„í•œ ë¶„í™ ë°°ê²½ */
      color: #6c1a21;
    }

    /* ë„¤ë¹„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .nav-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .nav-modal.hidden {
      display: none;
    }
    .modal-content {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      text-align: center;
      width: 280px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .modal-content h3 {
      margin-bottom: 10px;
      font-size: 18px;
    }
    .modal-content p {
      font-size: 14px;
      margin-bottom: 20px;
      word-break: break-word;
    }
    .nav-buttons button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background-color: #0056b3;
    }
    .nav-buttons button#nav-cancel {
      background-color: #ccc;
      color: #333;
    }

    /* ê° ì»¬ëŸ¼ ë„ˆë¹„ ê³ ì • */
    #address-table thead th:nth-child(1), #selected-table thead th:nth-child(1) { width: 30%; }
    #address-table thead th:nth-child(2), #selected-table thead th:nth-child(2) { width: 40%; }
    #address-table thead th:nth-child(3), #selected-table thead th:nth-child(3) { width: 15%; }
    #address-table thead th:nth-child(4), #selected-table thead th:nth-child(4) { width: 15%; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        padding: 10px;
        height: 100vh;
      }
      #right-container, #left-container {
        flex: none;
        width: 100%;
        max-height: none;
        height: auto;
      }
      #right-container {
        order: -1; /* ì§€ë„ë¥¼ ìœ„ë¡œ ì˜¬ë¦¼ */
        height: 50vh; /* ì§€ë„ ì˜ì—­ ë†’ì´ ê³ ì • */
        padding: 10px;
      }
      #map {
        height: 100%; /* ë¶€ëª¨ ë†’ì´ ê½‰ ì±„ì›€ */
        min-height: 0;
      }
    }
  </style>
</head>
<body>
  <div id="left-container">
    <!-- ì£¼ì†Œë§Œ ìˆëŠ” ì—‘ì…€ ì—…ë¡œë“œ â†’ ìœ„ë„ê²½ë„ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ -->
    <div class="container" id="address-convert-area">
      <h3>ğŸ“ ì£¼ì†Œë§Œ ìˆëŠ” ì—‘ì…€ ì—…ë¡œë“œ â†’ ìœ„ë„ê²½ë„ ë³€í™˜ í›„ ë‹¤ìš´ë¡œë“œ</h3>
      <input type="file" id="input-excel-addr" accept=".xlsx,.xls" />
      <button id="convert-download">ë³€í™˜ í›„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <div id="loading-indicator">ì£¼ì†Œ ë³€í™˜ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
    </div>

    <!-- ì¢Œí‘œ í¬í•¨ ì—‘ì…€ ì—…ë¡œë“œ + ê²€ìƒ‰ + ì„ íƒ ë¦¬ìŠ¤íŠ¸ -->
    <div class="container" style="flex-grow: 1; display: flex; flex-direction: column;">
      <h3>ğŸ“ ì¢Œí‘œ í¬í•¨ ì—‘ì…€ ì—…ë¡œë“œ + ê²€ìƒ‰</h3>
      <input type="file" id="input-excel" accept=".xlsx,.xls" />
      <input type="text" id="search-input" placeholder="ğŸ” ì—…ì²´ëª… ê²€ìƒ‰" />

      <h4>ê²€ìƒ‰ ê²°ê³¼ (í´ë¦­í•˜ì—¬ ì„ íƒ)</h4>
      <button id="select-all-search-results">ê²€ìƒ‰ê²°ê³¼ ì¼ê´„ ì¶”ê°€(ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€)</button>
      <button id="clear-search-result">ê²€ìƒ‰ê²°ê³¼ ì´ˆê¸°í™”</button>
      <div class="table-body-wrapper address-table">
        <table id="address-table">
          <thead>
            <tr>
              <th>ì—…ì²´ëª…</th>
              <th>ì£¼ì†Œ</th>
              <th>ìœ„ë„</th>
              <th>ê²½ë„</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h4>ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ (í´ë¦­í•˜ë©´ ì‚­ì œ)</h4>
      <button id="download-selected">ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button id="clear-selected">ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”</button>
      <div class="table-body-wrapper selected-table">
        <table id="selected-table">
          <thead>
            <tr>
              <th>ì—…ì²´ëª…</th>
              <th>ì£¼ì†Œ</th>
              <th>ìœ„ë„</th>
              <th>ê²½ë„</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="right-container">
    <h3>ğŸ“ ì§€ë„</h3>
    <button id="locate-btn" style="margin-bottom:10px;">ë‚´ ìœ„ì¹˜ í‘œì‹œ</button>
    <div id="map"></div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="password-modal">
    <div class="modal-box">
      <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
      <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <p id="password-error" style="color: red; display: none; margin-top: 5px;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
      <button id="password-submit">í™•ì¸</button>
      <button id="password-cancel">ì·¨ì†Œ</button>
    </div>
  </div>

  <!-- ë„¤ë¹„ ì„ íƒ ëª¨ë‹¬ -->
  <div id="nav-modal" class="nav-modal hidden">
    <div class="modal-content">
      <h3>ê¸¸ì°¾ê¸° ì•± ì„ íƒ</h3>
      <p id="nav-target-text"></p>
      <div class="nav-buttons">
        <button id="nav-naver">ë„¤ì´ë²„ ì§€ë„</button>
        <button id="nav-tmap">í‹°ë§µ</button>
        <button id="nav-cancel">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    let polylineLayer = null;  // ì—¬ê¸°ì„œ ì„ ì–¸
    let navTargetName = "";
    let navTargetAddress = "";

    // ë‚´íšŒì‚¬ ìœ„ì¹˜
    const myCompany = {
      name: "ì¹¼ë¼ì •ë³´ê¸°ìˆ ",
      address: "ê²½ê¸°ë„ ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì‹ ì›ë¡œ 55",
      lat: 37.2487505616809,
      lng: 127.047853564414
    };

    // ì¢Œí‘œ í¬í•¨ ë°ì´í„°, ì„ íƒëœ ë°ì´í„°
    let fullData = [];
    let selectedData = [];

    // ì£¼ì†Œë§Œ ë³€í™˜ìš© ë°ì´í„°
    let addrOnlyData = [];

    // UI ìš”ì†Œ
    const inputExcel = document.getElementById('input-excel');
    const searchInput = document.getElementById('search-input');
    const tbody = document.querySelector('#address-table tbody');
    const selectedTbody = document.querySelector('#selected-table tbody');
    const downloadBtn = document.getElementById('download-selected');

    const inputExcelAddr = document.getElementById('input-excel-addr');
    const convertBtn = document.getElementById('convert-download');
    const loadingIndicator = document.getElementById('loading-indicator');

    // ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
    const passwordModal = document.getElementById('password-modal');
    const passwordInput = document.getElementById('password-input');
    const passwordSubmit = document.getElementById('password-submit');
    const passwordCancel = document.getElementById('password-cancel');
    const passwordError = document.getElementById('password-error');

    // ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
    const correctPassword = '123123'; // ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½



    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map', { 
      fullscreenControl: true,
      minZoom: 9,
      maxZoom: 16
    }).setView([myCompany.lat, myCompany.lng], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markersGroup = L.layerGroup().addTo(map);

    if (!map.getPane('labelPane')) {
      map.createPane('labelPane');
      map.getPane('labelPane').style.zIndex = 650;
    }

    // ë‚´íšŒì‚¬ ë§ˆì»¤ (ë¶‰ì€ ì›)
    const myCompanyIcon = L.divIcon({
      className: '',
      html: `<div style="
        width: 12px;
        height: 12px;
        background: red;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 0 8px 2px rgba(255,0,0,0.7);
      "></div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 15],
      popupAnchor: [0, -15]
    });

    const myCompanyMarker = L.marker([myCompany.lat, myCompany.lng], {
      title: myCompany.name,
      icon: myCompanyIcon,
      zIndexOffset: 1000
    }).addTo(map);





    // ë‚´ë¹„ì—°ê²° ì½”ë“œ
    // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€ í•¨ìˆ˜
    function isMobile() {
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    // ë‚´ë¹„ì—°ê²° ëª¨ë‹¬ ì—´ê¸°
    function openNavModal(name, address) {
      console.log("openNavModal í˜¸ì¶œë¨:", name, address);
      navTargetName = name;
      navTargetAddress = address;
      document.getElementById("nav-target-text").innerHTML = `${name}<br>${address}`;
      document.getElementById("nav-modal").classList.remove("hidden");
    }

    // ë„¤ì´ë²„ ë‚´ë¹„ ì—°ê²°
    document.getElementById("nav-naver").addEventListener("click", () => {
      const query = encodeURIComponent(navTargetAddress || navTargetName);
      const url = `https://map.naver.com/v5/search/${query}`;
      window.open(url, "_blank");
      closeNavModal();
    });

    // í‹°ë§µ ë‚´ë¹„ ì—°ê²°
    document.getElementById("nav-tmap").addEventListener("click", () => {
      const query = encodeURIComponent(navTargetAddress || navTargetName);

      if (isMobile() && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            // í‹°ë§µ ì•± ë‚´ë¹„ í˜¸ì¶œ URI: ì¶œë°œì§€ ì¢Œí‘œ í¬í•¨
            const url = `tmap://route?goalname=${query}&goalx=&goaly=&startx=${lng}&starty=${lat}&appname=com.example.app`;

            window.open(url, "_blank");
            closeNavModal();
          },
          (err) => {
            // ìœ„ì¹˜ ëª»ë°›ìœ¼ë©´ ê·¸ëƒ¥ í‹°ë§µ ê²€ìƒ‰ í™”ë©´ í˜¸ì¶œ
            const url = `tmap://search?name=${query}`;
            window.open(url, "_blank");
            closeNavModal();
          }
        );
      } else {
        // PCëŠ” í‹°ë§µ ì›¹ ë‚´ë¹„ ì—†ìœ¼ë‹ˆ ë„¤ì´ë²„ ì§€ë„ ì›¹ìœ¼ë¡œ ìš°íšŒ
        const url = `https://map.naver.com/v5/search/${query}`;
        window.open(url, "_blank");
        closeNavModal();
      }
    });

    // ì·¨ì†Œ ë²„íŠ¼
    document.getElementById("nav-cancel").addEventListener("click", () => {
      closeNavModal();
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeNavModal() {
      document.getElementById("nav-modal").classList.add("hidden");
    }




    // ë§ˆì»¤ ê·¸ë£¹í•‘ í•¨ìˆ˜
    function getPixelThreshold() {
      return 30; // í”½ì…€ ê¸°ì¤€ (í•„ìš”ì‹œ ì¡°ì •)
    }
    function groupMarkersByProximity(locs, map, pixelThreshold) {
      const groups = [];
      const visited = new Array(locs.length).fill(false);
      for (let i = 0; i < locs.length; i++) {
        if (visited[i]) continue;
        visited[i] = true;
        const base = locs[i];
        const basePoint = map.latLngToLayerPoint([base.lat, base.lng]);
        const group = [base];
        for (let j = i + 1; j < locs.length; j++) {
          if (visited[j]) continue;
          const comp = locs[j];
          const compPoint = map.latLngToLayerPoint([comp.lat, comp.lng]);
          if (basePoint.distanceTo(compPoint) <= pixelThreshold) {
            visited[j] = true;
            group.push(comp);
          }
        }
        groups.push(group);
      }
      return groups;
    }

    // ì¢Œí‘œ í¬í•¨ ë°ì´í„° í…Œì´ë¸” ë Œë”ë§
    function renderTable(data) {
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.name}</td><td>${row.address || ''}</td><td>${row.lat}</td><td>${row.lng}</td>`;
        tr.addEventListener('click', () => addSelected(row));
        tbody.appendChild(tr);
      });
    }
    // ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderSelected() {
      selectedTbody.innerHTML = '';
      selectedData.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.name}</td><td>${row.address || ''}</td><td>${row.lat}</td><td>${row.lng}</td>`;
        tr.addEventListener('click', () => removeSelected(idx));
        selectedTbody.appendChild(tr);
      });
      refreshMap();
    }

    // ì¢Œí‘œ í¬í•¨ ì—‘ì…€ ì—…ë¡œë“œ
    inputExcel.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        fullData = jsonData.slice(1).map(row => ({
          name: row[0] || '',
          address: row[1] || '',
          lat: row[2] !== undefined ? parseFloat(row[2]) || 0 : 0,
          lng: row[3] !== undefined ? parseFloat(row[3]) || 0 : 0
        }));
        renderTable(fullData);
      };
      reader.readAsArrayBuffer(file);
    });

    // ê²€ìƒ‰ ê¸°ëŠ¥
    searchInput.addEventListener('input', function() {
      const keyword = this.value.trim().toLowerCase();
      if (!keyword) {
        renderTable(fullData);
        return;
      }
      const filtered = fullData.filter(row => row.name.toLowerCase().includes(keyword));
      renderTable(filtered);
    });

    // ì§€ë„ ê°±ì‹ 
    async function refreshMap() {
    markersGroup.clearLayers();
    myCompanyMarker.addTo(map);

    if (window.labelLinesGroup) {
      window.labelLinesGroup.clearLayers();
    } else {
      window.labelLinesGroup = L.layerGroup().addTo(map);
    }
    
    if (polylineLayer) {
        map.removeLayer(polylineLayer);
        polylineLayer = null;
    }

    const zoom = map.getZoom();
    const threshold = getPixelThreshold(zoom);
    const grouped = groupMarkersByProximity(selectedData, map, threshold);

    // âœ¨ ë¼ë²¨ ìœ„ì¹˜ ì¡°ì • ë° ê²¹ì¹¨ ë°©ì§€ íŒŒë¼ë¯¸í„°
    const baseOffset = 15; // ë§ˆì»¤ì—ì„œ ë¼ë²¨ì˜ ì´ˆê¸° ì˜¤í”„ì…‹ (í”½ì…€)
    const labelMoveStep = 10; // 8ë°©í–¥ íƒìƒ‰ ì‹œ ë¼ë²¨ì„ ì´ë™ì‹œí‚¬ í”½ì…€ ê°„ê²©
    const maxOverlapIterations = 1000; // ê²¹ì¹¨ í•´ê²° ì‹œë„ ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜

    const markersWithPos = []; 

    for (const group of grouped) {
        const popupContent = group.map(item => `
          <div class="nav-link" 
              data-name="${item.name}" 
              data-address="${item.address || ''}"
              style="cursor:pointer; color:#007bff; font-weight:bold;">
            ${item.name}<br/>
            <span>${item.address || 'ì£¼ì†Œ ì—†ìŒ'}</span>
          </div>
        `).join('<hr>');

        const base = group[0];
        const baseLatLng = L.latLng(base.lat, base.lng); 

        const realMarker = L.marker(baseLatLng).addTo(markersGroup);
        realMarker.bindPopup(popupContent);

        realMarker.on('popupopen', (e) => {
          const popupEl = e.popup.getElement();
          popupEl.querySelectorAll('.nav-link').forEach(el => {
            el.addEventListener('click', () => {
              const name = el.getAttribute('data-name');
              const address = el.getAttribute('data-address');
              openNavModal(name, address);
            });
          });
        });

        const html = group.map(i => i.name).join('<br />');
        const icon = L.divIcon({
          className: 'name-list-label',
          html,
          iconSize: null, 
          iconAnchor: [0, 20] 
        });

        // ë¼ë²¨ì˜ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (ë§ˆì»¤ì˜ í”½ì…€ ìœ„ì¹˜ + ì˜¤í”„ì…‹)
        let pos = map.latLngToLayerPoint(baseLatLng).add([baseOffset, 0]); 
        const labelMarker = L.marker(map.layerPointToLatLng(pos), {
          icon,
          interactive: true,
          pane: 'labelPane'
        }).addTo(markersGroup);

        labelMarker.bindPopup(popupContent);

        labelMarker.on('popupopen', (e) => {
          const popupEl = e.popup.getElement();
          popupEl.querySelectorAll('.nav-link').forEach(el => {
            el.addEventListener('click', () => {
              const name = el.getAttribute('data-name');
              const address = el.getAttribute('data-address');
              openNavModal(name, address);
            });
          });
        });

        // ë¼ë²¨ ë§ˆì»¤ì˜ DOM ìš”ì†Œê°€ ë Œë”ë§ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì„œ ì •í™•í•œ í¬ê¸°ë¥¼ ì–»ìŒ
        await new Promise(resolve => {
            const checkElement = () => {
                const el = labelMarker.getElement();
                if (el) {
                    markersWithPos.push({ 
                        marker: labelMarker, 
                        initialPos: pos.clone(), // ì´ˆê¸° í”½ì…€ ìœ„ì¹˜ (ê³ ì •)
                        pos, // í˜„ì¬ ì¡°ì •ë  í”½ì…€ ìœ„ì¹˜
                        width: el.offsetWidth, 
                        height: el.offsetHeight, 
                        originalLatLng: baseLatLng // ì›ë³¸ ë§ˆì»¤ì˜ LatLng
                    });
                    resolve();
                } else {
                    setTimeout(checkElement, 10); 
                }
            };
            checkElement();
        });
    }

    // âœ¨ ê²¹ì¹¨ ë°©ì§€ ë° 8ë°©í–¥ íƒìƒ‰ ë¡œì§
    const directions = [
        L.point(1, 0),    // ì˜¤ë¥¸ìª½
        L.point(1, -1),   // ì˜¤ë¥¸ìª½ ìœ„
        L.point(0, -1),   // ìœ„
        L.point(-1, -1),  // ì™¼ìª½ ìœ„
        L.point(-1, 0),   // ì™¼ìª½
        L.point(-1, 1),   // ì™¼ìª½ ì•„ë˜
        L.point(0, 1),    // ì•„ë˜
        L.point(1, 1)     // ì˜¤ë¥¸ìª½ ì•„ë˜
    ];

    let overlapped = true;
    let iteration = 0;

    while (overlapped && iteration < maxOverlapIterations) {
        overlapped = false; // ì´ë²ˆ ë°˜ë³µì—ì„œ ê²¹ì¹¨ì´ ìˆì—ˆëŠ”ì§€ ì—¬ë¶€
        
        // ê° ë¼ë²¨ì— ëŒ€í•´ ê²¹ì¹¨ ì—¬ë¶€ í™•ì¸
        for (let i = 0; i < markersWithPos.length; i++) {
            const currentLabel = markersWithPos[i];
            const currentBounds = L.bounds(currentLabel.pos, currentLabel.pos.add([currentLabel.width, currentLabel.height]));
            
            let hasOverlap = false;

            for (let j = 0; j < markersWithPos.length; j++) {
                if (i === j) continue; // ìê¸° ìì‹  ì œì™¸
                
                const otherLabel = markersWithPos[j];
                const otherBounds = L.bounds(otherLabel.pos, otherLabel.pos.add([otherLabel.width, otherLabel.height]));

                if (currentBounds.intersects(otherBounds)) {
                    hasOverlap = true;
                    overlapped = true; // ì „ì²´ ê²¹ì¹¨ í”Œë˜ê·¸ ì„¤ì •
                    break; // í˜„ì¬ ë¼ë²¨ì´ ë‹¤ë¥¸ ë¼ë²¨ê³¼ ê²¹ì³¤ìœ¼ë¯€ë¡œ ë” ì´ìƒ ë¹„êµí•  í•„ìš” ì—†ìŒ
                }
            }

            if (hasOverlap) {
                // ê²¹ì³¤ì„ ê²½ìš° 8ë°©í–¥ íƒìƒ‰í•˜ì—¬ ë¹ˆ ê³³ ì°¾ê¸°
                let foundSpot = false;
                // í˜„ì¬ ë¼ë²¨ì˜ ì›ë˜ í”½ì…€ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íƒìƒ‰
                const basePixelPos = map.latLngToLayerPoint(currentLabel.originalLatLng);

                for (const dir of directions) {
                    // ìƒˆë¡œìš´ ì œì•ˆ ìœ„ì¹˜ëŠ” ì›ë³¸ ë§ˆì»¤ ìœ„ì¹˜ì—ì„œ íŠ¹ì • ë°©í–¥ìœ¼ë¡œ ì´ë™
                    const proposedPos = basePixelPos.add(dir.multiplyBy(baseOffset + labelMoveStep * iteration)); 
                    
                    // ì œì•ˆëœ ìœ„ì¹˜ì— ë¼ë²¨ì„ ë†“ì•˜ì„ ë•Œ ê²¹ì¹¨ì´ ì—†ëŠ”ì§€ í™•ì¸
                    const proposedBounds = L.bounds(proposedPos, proposedPos.add([currentLabel.width, currentLabel.height]));
                    
                    let conflict = false;
                    for (let k = 0; k < markersWithPos.length; k++) {
                        if (i === k) continue; 
                        const existingLabel = markersWithPos[k];
                        const existingBounds = L.bounds(existingLabel.pos, existingLabel.pos.add([existingLabel.width, existingLabel.height]));
                        
                        if (proposedBounds.intersects(existingBounds)) {
                            conflict = true;
                            break;
                        }
                    }

                    if (!conflict) {
                        currentLabel.pos = proposedPos; // ë¹ˆ ê³³ ì°¾ìœ¼ë©´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                        foundSpot = true;
                        break; // ì´ë²ˆ ë¼ë²¨ì€ ìœ„ì¹˜ë¥¼ ì°¾ì•˜ìœ¼ë‹ˆ ë‹¤ìŒ ë¼ë²¨ë¡œ ì´ë™
                    }
                }

                // ëª¨ë“  ë°©í–¥ì„ íƒìƒ‰í–ˆì§€ë§Œ ë¹ˆ ê³³ì„ ì°¾ì§€ ëª»í–ˆë‹¤ë©´, í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¡°ê¸ˆ ë” ë°€ì–´ë‚´ëŠ” ë“± ë‹¤ë¥¸ ì „ëµì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜
                // ì—¬ê¸°ì„œëŠ” ë‹¤ìŒ ë°˜ë³µì—ì„œ ë‹¤ì‹œ ì‹œë„í•˜ë„ë¡ ë‘ . (maxOverlapIterationsì— ì˜í•´ ì œí•œë¨)
                if (!foundSpot) {
                    // Fallback: ê²¹ì³¤ì§€ë§Œ ë¹ˆ ê³µê°„ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°,
                    // ê¸°ì¡´ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ì˜ ì¼ë¶€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•½ê°„ ë°€ì–´ë‚´ëŠ” ë°©ì‹ì„
                    // ì¬ë„ì…í•˜ì—¬ ì™„ì „íˆ ê³ ì°©ë˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ë„ ìˆìŒ.
                    // í˜„ì¬ëŠ” ê·¸ëƒ¥ ë‘”ë‹¤. ë‹¤ìŒ ë°˜ë³µì—ì„œ ë” í° stepìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„.
                }
            }
        }
        iteration++;
        await new Promise(r => setTimeout(r, 0)); // UI ê°±ì‹ ì„ ìœ„í•œ ì§€ì—°
    }

    // ìµœì¢… ë¼ë²¨ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—°ê²°ì„  ê·¸ë¦¬ê³  ë¼ë²¨ ë§ˆì»¤ ì—…ë°ì´íŠ¸
    window.labelLinesGroup.clearLayers();

    markersWithPos.forEach(({ marker, pos, originalLatLng }) => {
        const labelLatLng = map.layerPointToLatLng(pos); 

        const line = L.polyline([originalLatLng, labelLatLng], {
            color: 'red',
            weight: 2,
            pane: 'overlayPane' 
        });
        window.labelLinesGroup.addLayer(line);
        marker.setLatLng(labelLatLng); 
    });
}






    // ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    downloadBtn.addEventListener('click', () => {
      if (selectedData.length === 0) {
        alert("ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const worksheetData = [
        ["ì—…ì²´ëª…", "ì£¼ì†Œ", "ìœ„ë„", "ê²½ë„"],
        ...selectedData.map(item => [item.name, item.address, item.lat, item.lng])
      ];
      const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "SelectedList");
      XLSX.writeFile(workbook, "selected_list.xlsx");
    });

    // Google Geocoding APIë¥¼ ì´ìš©í•œ ì£¼ì†Œ â†’ ìœ„ë„ê²½ë„ ë³€í™˜ í•¨ìˆ˜
    async function getCoordsByAddress(address) {
      const apiKey = "AIzaSyBxaNCAfmnLjdC_qxdG3lhuRVHOh0Vii8w"; // êµ¬ê¸€ API í‚¤
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;

      try {
        console.log("ì£¼ì†Œ ë³€í™˜ ìš”ì²­:", address);
        const res = await fetch(url);
        console.log("ì‘ë‹µ ìƒíƒœ:", res.status);
        if (!res.ok) {
          console.error("API ìš”ì²­ ì‹¤íŒ¨", res.status);
          return null;
        }
        const data = await res.json();
        console.log("ì‘ë‹µ ë°ì´í„°:", data);

        if (data.status === "OK" && data.results.length > 0) {
          const location = data.results[0].geometry.location;
          return {
            lat: location.lat,
            lng: location.lng
          };
        } else {
          console.warn("ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜ ìƒíƒœ:", data.status);
          return null;
        }
      } catch (e) {
        console.error("ì£¼ì†Œ ë³€í™˜ ì—ëŸ¬", e);
        return null;
      }
    }

    // ì£¼ì†Œë§Œ í¬í•¨ ì—‘ì…€ ì—…ë¡œë“œ
    inputExcelAddr.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        addrOnlyData = jsonData.slice(1).map(row => ({
          name: row[0] || '',
          address: row[1] || '',
          lat: 0,
          lng: 0
        }));
        alert(`ì£¼ì†Œ ë°ì´í„° ${addrOnlyData.length}ê±´ ì¤€ë¹„ ì™„ë£Œ`);
      };
      reader.readAsArrayBuffer(file);
    });

    // ë³€í™˜ ë²„íŠ¼ í´ë¦­ ì‹œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë„ìš°ê¸°
    convertBtn.addEventListener('click', () => {
      if (addrOnlyData.length === 0) {
        alert("ì£¼ì†Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      passwordInput.value = '';
      passwordError.style.display = 'none';
      passwordModal.classList.add('flex');
      passwordInput.focus();
    });

    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë²„íŠ¼
    passwordSubmit.addEventListener('click', async () => {
      const entered = passwordInput.value;
      if (entered === correctPassword) {
        passwordModal.classList.remove('flex');
        await convertAddressesToCoords();
      } else {
        passwordError.style.display = 'block';
        passwordInput.focus();
      }
    });

    // ë¹„ë°€ë²ˆí˜¸ ì·¨ì†Œ ë²„íŠ¼
    passwordCancel.addEventListener('click', () => {
      passwordModal.classList.remove('flex');
    });

    // ì—”í„°í‚¤ ëˆŒë €ì„ ë•Œ í™•ì¸ ì²˜ë¦¬
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        passwordSubmit.click();
      }
    });

    // ì£¼ì†Œ ë³€í™˜ + ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    async function convertAddressesToCoords() {
    loadingIndicator.style.display = 'block';

    for(let i = 0; i < addrOnlyData.length; i++) {
        const item = addrOnlyData[i];
        if (!item.address || item.address.trim() === '') {
        item.lat = 0;
        item.lng = 0;
        continue;
        }
        const coords = await getCoordsByAddress(item.address);
        if(coords) {
        item.lat = coords.lat;
        item.lng = coords.lng;
        } else {
        item.lat = 0;
        item.lng = 0;
        }
        await new Promise(r => setTimeout(r, 300)); // API ìš”ì²­ ì†ë„ ì¡°ì ˆ
    }

    // lat,lngê°€ 0ì¸ í•­ëª© ì œê±°
    const filteredData = addrOnlyData.filter(item => !(item.lat === 0 && item.lng === 0));

    const worksheetData = [
        ["ì—…ì²´ëª…", "ì£¼ì†Œ", "ìœ„ë„", "ê²½ë„"],
        ...filteredData.map(item => [item.name, item.address, item.lat, item.lng])
    ];
    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "ConvertedCoords");
    XLSX.writeFile(workbook, "converted_coordinates.xlsx");

    loadingIndicator.style.display = 'none';
    }
    // ì§€ë„ í™•ëŒ€ ì¶•ì†Œ ì‹œ ë§ˆì»¤ ë° ë¼ë²¨ ì¬ë°°ì¹˜
    map.on('zoomend', () => {
      refreshMap();
    });

    // ë‚´ìœ„ì¹˜í‘œì‹œì‹œ
    const locateBtn = document.getElementById('locate-btn');
    let userLocationMarker = null;

    locateBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
        alert("í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    locateBtn.disabled = true;
    locateBtn.textContent = "ìœ„ì¹˜ íƒìƒ‰ ì¤‘...";

    navigator.geolocation.getCurrentPosition(
        position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        if (userLocationMarker) {
            userLocationMarker.setLatLng([lat, lng]);
        } else {
            userLocationMarker = L.marker([lat, lng], {
            title: "ë‚´ ìœ„ì¹˜",
            icon: L.divIcon({
                className: '',
                html: `<div style="
                width: 14px;
                height: 14px;
                background: blue;
                border: 3px solid white;
                border-radius: 50%;
                box-shadow: 0 0 8px 2px rgba(0,0,255,0.7);
                "></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            })
            }).addTo(map).bindPopup("ë‚´ ìœ„ì¹˜");
        }

        map.setView([lat, lng], 11);
        userLocationMarker.openPopup();

        locateBtn.disabled = false;
        locateBtn.textContent = "ë‚´ ìœ„ì¹˜ í‘œì‹œ";
        },
        error => {
        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
        locateBtn.disabled = false;
        locateBtn.textContent = "ë‚´ ìœ„ì¹˜ í‘œì‹œ";
        }
    );
    });



    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ í•¨ìˆ˜
    function saveSelectedToLocalStorage() {
    localStorage.setItem('selectedData', JSON.stringify(selectedData));
    }

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    function loadSelectedFromLocalStorage() {
    const stored = localStorage.getItem('selectedData');
    if (stored) {
        try {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
            selectedData = parsed;
            renderSelected();
        }
        } catch (e) {
        console.error("ë¡œì»¬ìŠ¤í† ë¦¬ì§€ íŒŒì‹± ì˜¤ë¥˜", e);
        }
    }
    }

    // ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ë²„íŠ¼
    document.getElementById('clear-selected').addEventListener('click', () => {
      if (confirm("ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          selectedData = [];
          renderSelected();
          localStorage.removeItem('selectedData');
      }
    });

    //ìˆ˜ì •ëœ add/removeSelected í•¨ìˆ˜(ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥)
    function addSelected(row) {
      if (!selectedData.some(item => item.name === row.name && item.lat === row.lat && item.lng === row.lng)) {
          selectedData.push(row);
          renderSelected();
          saveSelectedToLocalStorage(); // ì €ì¥
      }
    }
    function removeSelected(idx) {
      selectedData.splice(idx, 1);
      renderSelected();
      saveSelectedToLocalStorage(); // ì €ì¥
    }



    // ê²€ìƒ‰ê²°ê³¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
    function saveFullDataToLocalStorage() {
      localStorage.setItem('fullData', JSON.stringify(fullData));
    }

    // ê²€ìƒ‰ê²°ê³¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadFullDataFromLocalStorage() {
      const stored = localStorage.getItem('fullData');
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (Array.isArray(parsed)) {
            fullData = parsed;
            renderTable(fullData);
          }
        } catch (e) {
          console.error("fullData íŒŒì‹± ì˜¤ë¥˜", e);
        }
      }
    }

    // ê²€ìƒ‰ê²°ê³¼ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('clear-search-result').addEventListener('click', () => {
      if (confirm("ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        fullData = [];
        renderTable(fullData);
        localStorage.removeItem('fullData');
      }
    });

    // ê²€ìƒ‰ì–´ ì…ë ¥ì‹œ ë Œë”ë§ í›„ ì €ì¥
    searchInput.addEventListener('input', function() {
      const keyword = this.value.trim().toLowerCase();
      if (!keyword) {
        renderTable(fullData);
        saveFullDataToLocalStorage();
        return;
      }
      const filtered = fullData.filter(row => row.name.toLowerCase().includes(keyword));
      renderTable(filtered);
      saveFullDataToLocalStorage();
    });

    // ì—‘ì…€ ì—…ë¡œë“œ í›„ ë Œë”ë§ ë° ì €ì¥
    inputExcel.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        fullData = jsonData.slice(1).map(row => ({
          name: row[0] || '',
          address: row[1] || '',
          lat: row[2] !== undefined ? parseFloat(row[2]) || 0 : 0,
          lng: row[3] !== undefined ? parseFloat(row[3]) || 0 : 0
        }));
        renderTable(fullData);
        saveFullDataToLocalStorage();
      };
      reader.readAsArrayBuffer(file);
    });



    document.getElementById('select-all-search-results').addEventListener('click', () => {
      // í˜„ì¬ ì£¼ì†Œ í…Œì´ë¸”ì— ë³´ì´ëŠ” ë°ì´í„°(=ê²€ìƒ‰ê²°ê³¼) ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ì„ íƒ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(tr => {
        const cells = tr.children;
        const rowData = {
          name: cells[0].textContent,
          address: cells[1].textContent,
          lat: parseFloat(cells[2].textContent),
          lng: parseFloat(cells[3].textContent)
        };
        // ì¤‘ë³µ í™•ì¸ í›„ ì¶”ê°€
        if (!selectedData.some(item => item.name === rowData.name && item.lat === rowData.lat && item.lng === rowData.lng)) {
          selectedData.push(rowData);
        }
      });
      renderSelected();
      saveSelectedToLocalStorage();
    });



    window.addEventListener('DOMContentLoaded', () => {
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„ íƒëœ ë¦¬ìŠ¤íŠ¸ ë° ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
      loadSelectedFromLocalStorage();
      loadFullDataFromLocalStorage();

      // ëª¨ë°”ì¼ ì—¬ë¶€ í™•ì¸ (ê°€ë¡œí­ 768px ì´í•˜)
      const isMobile = window.innerWidth <= 768;

      // ëª¨ë°”ì¼ì´ê³  ìœ„ì¹˜ ì •ë³´ ì‚¬ìš© ê°€ëŠ¥í•˜ë©´
      if (isMobile && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            // í˜„ì¬ ìœ„ì¹˜ ì¢Œí‘œ ë°›ì•„ì˜¤ê¸°
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // ì§€ë„ ì¤‘ì‹¬ì„ ë‚´ ìœ„ì¹˜ë¡œ ì„¤ì •
            map.setView([lat, lng], 11);

            // ì§€ë„ê°€ ë³´ì´ë„ë¡ ê°•ì œë¡œ í¬ê¸° ì¬ê³„ì‚°
            map.whenReady(() => {
              map.invalidateSize();
            });

            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ìœ„ì¹˜ë§Œ ì´ë™, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (userLocationMarker) {
              userLocationMarker.setLatLng([lat, lng]);
            } else {
              userLocationMarker = L.marker([lat, lng], {
                title: "ë‚´ ìœ„ì¹˜",
                icon: L.divIcon({
                  className: '',
                  html: `<div style="
                    width: 14px;
                    height: 14px;
                    background: blue;
                    border: 3px solid white;
                    border-radius: 50%;
                    box-shadow: 0 0 8px 2px rgba(0,0,255,0.7);
                  "></div>`,
                  iconSize: [30, 30],
                  iconAnchor: [15, 15],
                  popupAnchor: [0, -15]
                })
              }).addTo(map).bindPopup("ë‚´ ìœ„ì¹˜").openPopup();
            }
          },
          error => {
            // ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í•˜ë©´ ë‚´ íšŒì‚¬ ìœ„ì¹˜ë¡œ ì´ë™
            console.warn("GPS ì‹¤íŒ¨: ë‚´ íšŒì‚¬ ìœ„ì¹˜ë¡œ ì´ˆê¸°í™”");
            map.setView([myCompany.lat, myCompany.lng], 11);
            map.whenReady(() => map.invalidateSize());
          }
        );
      } else {
        // ë°ìŠ¤í¬íƒ‘ì´ê±°ë‚˜ GPS ë¯¸ì§€ì›ì¸ ê²½ìš° ë‚´ íšŒì‚¬ ìœ„ì¹˜ë¡œ ì´ˆê¸°í™”
        map.setView([myCompany.lat, myCompany.lng], 11);
        map.whenReady(() => map.invalidateSize());
      }
    });


    
  </script>
</body>
</html>
